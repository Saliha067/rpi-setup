---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present

- name: Remove distro docker packages if present
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-compose
      - docker-doc
      - podman-docker
      - containerd
      - runc
    state: absent
  ignore_errors: true

- name: Create /etc/apt/keyrings
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Download Docker's official GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: "0644"
    force: true

- name: Set Docker apt architecture
  ansible.builtin.set_fact:
    docker_arch: >-
      {{
        'amd64' if ansible_architecture in ['x86_64', 'amd64'] else
        'arm64' if ansible_architecture in ['aarch64', 'arm64'] else
        'armhf' if ansible_architecture in ['armv7l', 'armv6l'] else
        ansible_architecture
      }}

- name: Add Docker apt repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ docker_arch }} signed-by=/etc/apt/keyrings/docker.asc]
      https://download.docker.com/linux/ubuntu
      {{ ansible_distribution_release }} stable
    filename: docker
    state: present
    update_cache: yes

- name: Install Docker Engine + Compose v2 plugin
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes

- name: Fix docker systemd startup (socket activation)
  block:
    - name: Ensure docker.socket is enabled and started
      ansible.builtin.systemd:
        name: docker.socket
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Reset failed docker units (if any)
      ansible.builtin.command: systemctl reset-failed docker docker.socket
      changed_when: false
      failed_when: false

    - name: Ensure docker service is enabled and started
      ansible.builtin.systemd:
        name: docker.service
        state: started
        enabled: yes
        daemon_reload: yes

  rescue:
    - name: Create systemd override directory for docker.service
      ansible.builtin.file:
        path: /etc/systemd/system/docker.service.d
        state: directory
        mode: "0755"

    - name: Override docker.service ExecStart to use unix socket directly
      ansible.builtin.copy:
        dest: /etc/systemd/system/docker.service.d/override.conf
        mode: "0644"
        content: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/dockerd -H unix:///run/docker.sock --containerd=/run/containerd/containerd.sock

    - name: Disable docker.socket (not needed when not using fd://)
      ansible.builtin.systemd:
        name: docker.socket
        state: stopped
        enabled: no
        masked: no

    - name: Reload systemd and restart docker
      ansible.builtin.systemd:
        daemon_reload: yes
        name: docker.service
        state: restarted
        enabled: yes

    - name: Show docker logs if still failing
      ansible.builtin.command: journalctl -u docker.service -b --no-pager -n 120
      register: docker_logs
      changed_when: false
      failed_when: false

    - name: Print docker logs
      ansible.builtin.debug:
        var: docker_logs.stdout

    - name: Fail if docker still not running
      ansible.builtin.command: systemctl is-active docker
      register: docker_active
      changed_when: false
      failed_when: docker_active.stdout.strip() != "active"

- name: Add admin user to docker group
  ansible.builtin.user:
    name: "{{ admin_user | default(ansible_user | default(ansible_ssh_user)) }}"
    groups: docker
    append: yes

- name: Verify docker and compose versions
  ansible.builtin.command: "{{ item }}"
  loop:
    - docker --version
    - docker compose version
  register: docker_cmds
  changed_when: false

- name: Show docker/compose output
  ansible.builtin.debug:
    var: docker_cmds.results | map(attribute='stdout') | list
